# -*- Mode: Python -*- vi:si:et:sw=4:sts=4:ts=4:syntax=python

class Recipe(recipe.Recipe):
    name = 'gtk-doc-lite'
    version = '1.27'
    stype = SourceType.TARBALL
    tarball_dirname = 'gtk-doc-%(version)s'
    maj_ver = '.'.join(version.split('.')[0:2])
    url = 'https://download.gnome.org/sources/{0}/{1}/{0}-{2}.tar.xz'.format('gtk-doc', maj_ver, version)
    tarball_checksum = 'e26bd3f7080c749b1cb66c46c6bf8239e2f320a949964fb9c6d56e1b0c6d9a6f'
    # TODO: check license - source files are GPLv2+ and COPYING is GPLv3
    licenses = [License.GPLv2Plus]
    btype = BuildType.CUSTOM

    files_devel = ['bin/gtkdocize', 'share/aclocal/gtk-doc.m4',
                   'share/gtk-doc/data/gtk-doc.make',
                   'share/gtk-doc/data/gtk-doc.notmpl.make']

    def install(self):
        from cerbero.utils import shell
        import shutil
        aclocal_dir = os.path.join(self.config.prefix, 'share', 'aclocal')
        if not os.path.exists(aclocal_dir):
            os.makedirs(aclocal_dir)
        data_dir = os.path.join(self.config.prefix, 'share', 'gtk-doc', 'data')
        if not os.path.exists(data_dir):
            os.makedirs(data_dir)
        bin_dir = os.path.join(self.config.prefix, 'bin')
        if not os.path.exists(bin_dir):
            os.makedirs(bin_dir)
        shutil.copy(os.path.join(self.build_dir, 'gtk-doc.m4'),
                    os.path.join(aclocal_dir, 'gtk-doc.m4'))
        shutil.copy(os.path.join(self.build_dir, 'gtk-doc.make'),
                    os.path.join(data_dir,  'gtk-doc.make'))
        gtkdocize = os.path.join(self.config.prefix, 'bin', 'gtkdocize')
        shutil.copy(os.path.join(self.build_dir, 'gtkdocize.in'), gtkdocize)
        replacements = {'@PACKAGE@': 'gtk-doc', '@VERSION@': self.version,
                        '@prefix@': self.config.prefix,
                        '@datarootdir@': '${prefix}/share',
                        '@datadir@': '${datarootdir}'}
        shell.replace(gtkdocize, replacements)
        shell.call('chmod +x gtkdocize', os.path.join(self.config.prefix, 'bin'))
